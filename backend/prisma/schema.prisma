// Captain Bitbeard Database Schema
// Prisma ORM Schema Definition

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Management
// ============================================

model User {
  id            String   @id @default(uuid())
  username      String   @unique
  email         String   @unique
  passwordHash  String   @map("password_hash")
  role          UserRole @default(USER)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  profile          UserProfile?
  saveStates       SaveState[]
  favorites        Favorite[]
  playHistory      PlayHistory[]
  collections      Collection[]
  collectionShares CollectionShare[]
  savedSearches    SavedSearch[]

  @@map("users")
}

enum UserRole {
  ADMIN
  USER
}

model UserProfile {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  avatarUrl String?  @map("avatar_url")
  bio       String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

// ============================================
// Game Library
// ============================================

model Game {
  id              String    @id @default(uuid())
  title           String
  system          String    // nes, snes, gb, etc.
  romPath         String    @map("rom_path")   // MinIO path
  coverUrl        String?   @map("cover_url")  // MinIO URL (primary cover)
  boxArtUrl       String?   @map("box_art_url") // Alternative box art
  backgroundUrl   String?   @map("background_url") // Fanart/background image
  logoUrl         String?   @map("logo_url")    // Game logo
  videoUrl        String?   @map("video_url")   // Trailer/gameplay video URL
  description     String?
  releaseDate     DateTime? @map("release_date")
  developer       String?
  publisher       String?
  genre           String?
  players         Int?      // Number of players (1-4)
  rating          Float?    // User rating
  screenscrapeId  String?   @map("screenscrape_id") @unique
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  metadata       GameMetadata?
  screenshots    Screenshot[]
  saveStates     SaveState[]
  favorites      Favorite[]
  playHistory    PlayHistory[]
  collectionGames CollectionGame[]

  @@index([system])
  @@index([title])
  @@map("games")
}

model GameMetadata {
  id        String   @id @default(uuid())
  gameId    String   @unique @map("game_id")
  esrbRating String? @map("esrb_rating")
  region    String?
  language  String?
  fileSize  BigInt?  @map("file_size") // In bytes
  md5Hash   String?  @map("md5_hash")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@map("game_metadata")
}

model Screenshot {
  id        String   @id @default(uuid())
  gameId    String   @map("game_id")
  url       String   // MinIO URL
  type      String   @default("gameplay") // gameplay, title, box
  order     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")

  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@index([gameId])
  @@map("screenshots")
}

// ============================================
// BIOS Management
// ============================================

model BiosFile {
  id        String   @id @default(uuid())
  system    String   // ps1, saturn, etc.
  fileName  String   @map("file_name")
  filePath  String   @map("file_path")  // MinIO path
  md5Hash   String   @map("md5_hash")
  required  Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([system, fileName])
  @@map("bios_files")
}

// ============================================
// Save States
// ============================================

model SaveState {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  gameId        String   @map("game_id")
  slot          Int      @default(1) // Save slot number (1-10)
  statePath     String   @map("state_path") // MinIO path to .state file
  screenshotUrl String?  @map("screenshot_url")
  description   String?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId, slot])
  @@index([userId])
  @@index([gameId])
  @@map("save_states")
}

// ============================================
// User Interactions
// ============================================

model Favorite {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  gameId    String   @map("game_id")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId])
  @@index([userId])
  @@map("favorites")
}

model PlayHistory {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  gameId     String   @map("game_id")
  playedAt   DateTime @default(now()) @map("played_at")
  duration   Int?     // Play duration in seconds
  completed  Boolean  @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([gameId])
  @@index([playedAt])
  @@map("play_history")
}

model Collection {
  id          String               @id @default(uuid())
  userId      String               @map("user_id")
  name        String
  description String?
  visibility  CollectionVisibility @default(PRIVATE)
  shareLink   String?              @unique @map("share_link") // UUID for unlisted sharing
  createdAt   DateTime             @default(now()) @map("created_at")
  updatedAt   DateTime             @updatedAt @map("updated_at")

  user   User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  games  CollectionGame[]
  shares CollectionShare[]

  @@index([userId])
  @@index([visibility])
  @@map("collections")
}

enum CollectionVisibility {
  PRIVATE  // Only owner can see
  PUBLIC   // Everyone can see
  UNLISTED // Accessible via share link
}

model CollectionShare {
  id           String          @id @default(uuid())
  collectionId String          @map("collection_id")
  userId       String?         @map("user_id") // null = anonymous via link
  permission   SharePermission @default(VIEW)
  createdAt    DateTime        @default(now()) @map("created_at")

  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  user       User?      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([collectionId, userId])
  @@index([collectionId])
  @@index([userId])
  @@map("collection_shares")
}

enum SharePermission {
  VIEW // Can view collection
  EDIT // Can add/remove games
}

model CollectionGame {
  collectionId String   @map("collection_id")
  gameId       String   @map("game_id")
  order        Int      @default(0)
  addedAt      DateTime @default(now()) @map("added_at")

  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  game       Game       @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@id([collectionId, gameId])
  @@index([collectionId])
  @@index([gameId])
  @@map("collection_games")
}

// ============================================
// Saved Searches
// ============================================

model SavedSearch {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String
  query       String?  // Full-text search query
  systems     String[] // Array of systems
  genres      String[] // Array of genres
  developers  String[] // Array of developers
  publishers  String[] // Array of publishers
  yearFrom    Int?     @map("year_from")
  yearTo      Int?     @map("year_to")
  players     Int?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("saved_searches")
}

// ============================================
// Admin Operations
// ============================================

model UploadJob {
  id          String       @id @default(uuid())
  adminId     String       @map("admin_id") // User ID of admin
  status      JobStatus    @default(PENDING)
  totalFiles  Int          @default(0) @map("total_files")
  processed   Int          @default(0)
  failed      Int          @default(0)
  errorLog    String?      @map("error_log")
  startedAt   DateTime?    @map("started_at")
  completedAt DateTime?    @map("completed_at")
  createdAt   DateTime     @default(now()) @map("created_at")

  @@index([adminId])
  @@index([status])
  @@map("upload_jobs")
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
